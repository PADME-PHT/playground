# Playground Backend

## Prerequisites

The backend relies on [Blazegraph](https://blazegraph.com/) as a its graph database. Unfortunately, there is no official docker image available yet, which is why we build one locally. To do this, please execute the following steps (once) before starting the backend setup:

1. Navigate to the [blazegraph release page](https://github.com/blazegraph/database/releases/tag/BLAZEGRAPH_2_1_6_RC)
2. Download the latest released **'blazegraph.jar'** file. At the moment this is version 2.1.6 from february 2020.
3. Place the downloaded file into the ```/src/external/blazegraph``` folder

Now you can proceed with the setup.

## Setup

As stated in the Readme of the parent folder, this backend supports [VSC dev containers](https://code.visualstudio.com/docs/devcontainers/containers). After installing Docker and the mentioned plugin, please press F1 and select 'Dev Containers: Rebuild Container Without Cache'. In the selection afterward, select the backend. Once the container has been build and VSV reopened successfully, do the following steps (1-3 need to be done once):

### 1. Initialize Blazegraph with example data

1. Navigate to http://localhost:9999 and switch to the 'Update' tab
2. In the 'Type' dropdown below choose "**RDF Data**" and in the 'Format' dropdown choose "**Turtle**"
3. Paste the contents from ```/src/backend/development/workingdata.ttl``` and press "Update".

This data provides example databases and stations that an be used for development and are helpful while testing the Playgrounds features. Additional schemas are available in the ```/evaluation/``` sub-folders.

### 2. Create a client in the local keycloak instance 

1. Navigate to http://localhost:8080
2. Click on 'Administration console'
3. Login with the credentials 'admin' (user) and 'admin' (pass)
4. Navigate to 'Clients' on the left side and click 'Import client' next to 'Create Client' button
5. Select 'Browse' and import the the file from ```src/backend/development/playground.json```
6. Click Save

Now keycloak should be working and you can login to the app with the credentials admin (user) and admin (pass). You can also create other users if you like. 

**Important:** please be aware that the backend does not access keycloak directly but via a port forwarding and a localhost port. You can find more details in the docker-compose-dev.yml file. The reason for this step is that if you use e.g. http://keycloak:8080 as a address we get name clashes when validating. This is because the token is generated by the frontend via the http://localhost:8080 address. So if there is ever any problem with keycloak communication, or the connection of the DEV container terminates all the time, please investigate if this is a issue with the port forwarding and nc command.

### 3. Install dependencies

Lastly, please execute ```npm install``` in the ```/src/backend/src/```folder. This installs all the needed dependencies and libraries.

### 4. Start the backend

Now you can start the backend. This is possible by simply pressing F5 or the play button in VSC. Everything should be running now and accessible on your host via port 1234.

You can now proceed with the frontend setup.

### Caveat when using VSC F5/Play for starting the backend

When debugging the backend there unfortunately is **one caveat** that you should be aware of:

When debugging and pressing the stop button, VS code always sends a SIGKILL signal. The app listens to SIGINT and SIGTERM to gracefully shutdown, which means the app will not gracefully shutdown when stopping via the vscode debug mode. However, this also means that cleanup tasks will not be performed at the end of the app runtime. Therefore: From time to time, clean the container, images, networks etc. in the playground-dind container that are kept there from the debugging sessions. Alternatively, you can get rid of the playground-dind container completly (e.g. via Docker Desktop) and create a new one (e.g., by doing a rebuild of the devcontainer in VSC as described above).